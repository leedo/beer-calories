// Generated by CoffeeScript 1.6.3
(function() {
  var build_untappd_calories, calculate_calories, delete_cookie, expires_in_to_date, filter_url_params, get_cookie, parse_query_string, set_access_token_cookie, set_cookie, untappd_api_url, untappd_auth_url, untappd_config;

  untappd_config = {
    client_id: '6CEC661CC1E87C1BE1B7D7FE30865F670AF6218B',
    redirect_url: window.location.href.replace("" + location.hash, ''),
    response_type: 'token'
  };

  untappd_api_url = 'https://api.untappd.com/v4';

  untappd_auth_url = function() {
    return "https://untappd.com/oauth/authenticate/?" + ($.param(untappd_config));
  };

  expires_in_to_date = function(expires_in) {
    var cookie_expires;
    cookie_expires = new Date;
    cookie_expires.setTime(cookie_expires.getTime() + expires_in * 1000);
    return cookie_expires;
  };

  set_cookie = function(key, value, expires_in) {
    var cookie;
    cookie = "" + key + "=" + value + "; ";
    cookie += "expires=" + (expires_in_to_date(expires_in).toUTCString()) + "; ";
    cookie += "path=" + (window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1));
    return document.cookie = cookie;
  };

  delete_cookie = function(key) {
    return set_cookie(key, null, -1);
  };

  get_cookie = function(key) {
    var cookie_fragment, _i, _len, _ref;
    key += "=";
    _ref = document.cookie.split(';');
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      cookie_fragment = _ref[_i];
      cookie_fragment = cookie_fragment.replace(/^\s+/, '');
      if (cookie_fragment.indexOf(key) === 0) {
        return cookie_fragment.substring(key.length, cookie_fragment.length);
      }
    }
    return null;
  };

  set_access_token_cookie = function(params, callback) {
    if (params['state'] != null) {
      console.log("Replacing hash with state: " + params['state']);
      history.replaceState(null, '', window.location.href.replace("" + location.hash, "#" + params['state']));
    }
    if (params['access_token'] != null) {
      console.log("Got access token: " + params['access_token']);
      set_cookie('access_token', params['access_token'], 31536000);
      if (callback != null) {
        return callback(params);
      }
    } else {
      if (callback != null) {
        return callback(params);
      }
    }
  };

  parse_query_string = function(query_string) {
    var m, params, regex;
    if (query_string == null) {
      query_string = location.hash.substring(1);
    }
    params = {};
    if (query_string.length > 0) {
      regex = /([^&=]+)=([^&]*)/g;
      while (m = regex.exec(query_string)) {
        params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
      }
    }
    return params;
  };

  filter_url_params = function(params, filtered_params) {
    var hash_string, key, rewritten_params, value;
    rewritten_params = [];
    if (filtered_params == null) {
      filtered_params = ['access_token', 'expires_in', 'token_type'];
    }
    for (key in params) {
      value = params[key];
      if (!_.include(filtered_params, key)) {
        rewritten_params.push("" + key + "=" + value);
      }
    }
    if (rewritten_params.length > 0) {
      hash_string = "#" + (rewritten_params.join('&'));
    } else {
      hash_string = '';
    }
    history.replaceState(null, '', window.location.href.replace("" + location.hash, hash_string));
    return params;
  };

  calculate_calories = function(abv, floz) {
    if (floz == null) {
      floz = 12;
    }
    return floz * abv / 60 * 150;
  };

  build_untappd_calories = function(params) {
    if (get_cookie('access_token')) {
      $('#untappd_button').append('<a href="#">Fill ABV from last Untappd checkin</a>');
      return $.ajax("" + untappd_api_url + "/user/checkins/?access_token=" + (get_cookie('access_token')) + "&limit=1", {
        type: 'GET',
        dataType: 'json',
        crossDomain: true,
        success: function(data) {
          var beer;
          console.log(data);
          beer = data['response']['checkins']['items'][0]['beer'];
          console.log(calculate_calories(beer['beer_abv']));
          $('#content').append('<div id="last_checkin" align="center" id="ui-body-untappd" class="ui-body ui-body-a ui-corner-all">');
          return $('#last_checkin').append("<p>Last Untappd checkin: " + beer['beer_name'] + " (<span id=\"last_abv\">" + beer['beer_abv'] + "</span>% ABV)</p>");
        }
      });
    } else {
      return $('#untappd_button').append("<a href=\"" + (untappd_auth_url()) + "\">Log in to Untappd</a>");
    }
  };

  $(document).ready(function() {
    return set_access_token_cookie(filter_url_params(parse_query_string()), build_untappd_calories);
  });

}).call(this);
